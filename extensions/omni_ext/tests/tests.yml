instances:
  with_omni_ext:
    default: true
    config:
      shared_preload_libraries: */env/OMNI_EXT_SO
    init:
    - create extension omni_ext cascade

  with_omni_ext_test:
    config:
      shared_preload_libraries: */env/OMNI_EXT_SO
    init:
      - create extension omni_ext_test cascade

  with_omni_ext_test_no_preload:
    config:
      shared_preload_libraries: */env/OMNI_EXT_SO
    init:
      - create extension omni_ext_test_no_preload cascade

tests:
  - query: select omni_ext.load('omni_ext_test')
    results:
      - load: 0.1

  - name: load version
    steps:
      - query: select omni_ext.load('omni_ext_test', 'unknown')
        results:
          - load:
      - query: select omni_ext.load('omni_ext_test', '0.1')
        results:
          - load: 0.1

  - name: shmem
    instance: with_omni_ext_test
    steps:
      - name: Should be initialized since it's preloaded
        query: select omni_ext_test.alloc_shmem_global()
        results:
          - alloc_shmem_global: test

      - name: database-local
        query: select omni_ext_test.alloc_shmem_database_local()
        results:
          - alloc_shmem_database_local: 'testdb 0'

  - name: reloading
    instance: with_omni_ext_test
    steps:
      - name: preloaded value
        query: select omni_ext_test.alloc_shmem_global()
        results:
        - alloc_shmem_global: test
      - name: modify value
        query: select omni_ext_test.update_global_value('updated')
        results:
          - update_global_value: updated
      - name: re-load again
        query: select omni_ext.load('omni_ext_test')
        results:
          - load: 0.1
      - name: should not be rolled back to the initial value
        query: select omni_ext_test.alloc_shmem_global()
        results:
          - alloc_shmem_global: updated

  - name: shmem no preload
    instance: with_omni_ext_test_no_preload
    steps:
      - name: fail since it's not preloaded
        query: select omni_ext_test_no_preload.alloc_shmem_global()
        error:
          severity: ERROR
          message: no allocation found
      - query: select omni_ext_test_no_preload.alloc_shmem_database_local()
        error:
          severity: ERROR
          message: no allocation found
      - name: Load
        query: select omni_ext.load('omni_ext_test_no_preload')
        results:
        - load: 0.1
      - name: alloc_shmem_global() should work after loading
        query: select omni_ext_test_no_preload.alloc_shmem_global()
        results:
        - alloc_shmem_global: test
      - name: alloc_shmem_database_local() should work after loading
        query: select omni_ext_test_no_preload.alloc_shmem_database_local()
        results:
        - alloc_shmem_database_local: testdb 0
